<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <meta name="author" content="USER_NAME">
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Introduction - PACKAGE_NAME.jl</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../../css/highlight.css">
  <link href="../../assets/Documenter.css" rel="stylesheet">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Introduction";
    var mkdocs_page_input_path = "solver/Readme.md";
    var mkdocs_page_url = "/solver/Readme/";
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js"></script>
  <script src="../../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> PACKAGE_NAME.jl</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../interfaces/">Code Interfaces</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../parallel/">Code Parallelization</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">PDESolver</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../pdesolver/">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../../pdesolver_user/">PDESolver User Interface</a>
                </li>
                <li class="">
                    
    <a class="" href="../../pdesolver_physics/">PDESolver Physics Interface</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Solver</span>
    <ul class="subnav">
                <li class=" current">
                    
    <a class="current" href="./">Introduction</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#overview-of-physics-modules">Overview of Physics Modules</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#abstractsolutiondata-and-physics-module-implementation">AbstractSolutionData and Physics Module Implementation</a></li>
        
            <li><a class="toctree-l4" href="#levels-of-functions">Levels of Functions</a></li>
        
            <li><a class="toctree-l4" href="#abstractsolutiondata-implementation">AbstractSolutionData implementation</a></li>
        
            <li><a class="toctree-l4" href="#input-options">Input Options</a></li>
        
            <li><a class="toctree-l4" href="#functors">Functors</a></li>
        
        </ul>
    

    <li class="toctree-l3"><a href="#initialization-of-a-simulation">Initialization of a Simulation</a></li>
    

    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Advection</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../advection/advection/">Introduction</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../advection/types/">Datatypes</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../advection/volume/">Volume Integrals</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../advection/flux/">Face Integrals</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../advection/bc/">Boundary Integrals</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../advection/ic/">Initial Conditions</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../advection/source/">Source Term</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../advection/common/">Common Functions</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../advection/adjoint/">Adjoint</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../advection/boundary_functional/">Boundary Functional</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <span class="caption-text">Euler</span>
    <ul class="subnav">
                <li class="toctree-l3">
                    
    <a class="" href="../euler/euler/">Introduction</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../euler/types/">Datatypes</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../euler/volume/">Volume Integrals</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../euler/flux/">Face Integrals</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../euler/bc/">Boundary Integrals</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../euler/ic/">Initial Conditions</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../euler/source/">Source Term</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../euler/common/">Common Functions</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../euler/conversion/">Conversion</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../euler/flux_functions/">Numerical Flux Functions</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../euler/stabilization/">Stabilization</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../euler/adjoint/">Adjoint</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../euler/boundary_functional/">Boundary Functional</a>
                </li>
                <li class="toctree-l3">
                    
    <a class="" href="../euler/misc/">Misc</a>
                </li>
    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../simpleODE/simpleODE/">Simple ODE</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../input/input/">Input</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Nonlinear Solvers</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../NonlinearSolvers/nonlinearsolvers/">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../../NonlinearSolvers/steady/">Steady</a>
                </li>
                <li class="">
                    
    <a class="" href="../../NonlinearSolvers/unsteady/">Unsteady</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Utils</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../Utils/Utils/">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Utils/parallel/">Parallel Constructs</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Utils/projections/">Projections</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Utils/logging/">Logging</a>
                </li>
                <li class="">
                    
    <a class="" href="../../Utils/io/">Input/Output</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">PACKAGE_NAME.jl</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Solver &raquo;</li>
        
      
    
    <li>Introduction</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/USER_NAME/PACKAGE_NAME.jl/edit/master/docs/solver/Readme.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <p><a id='Overview-of-Physics-Modules-1'></a></p>
<h1 id="overview-of-physics-modules">Overview of Physics Modules</h1>
<p><a id='AbstractSolutionData-and-Physics-Module-Implementation-1'></a></p>
<h2 id="abstractsolutiondata-and-physics-module-implementation"><code>AbstractSolutionData</code> and Physics Module Implementation</h2>
<p>This document describes some best practices for implementing a physics module. These practices are not required, but have proven to be useful for producing organized, readable, and reusable code.</p>
<p><a id='Levels-of-Functions-1'></a></p>
<h2 id="levels-of-functions">Levels of Functions</h2>
<p>It is useful to divide functions into 3 catagories, high, mid, and low level functions.  The purpose of high level functions is to decide which method of performing an operation should be used and call other functions to do it. For example, the Euler physics modules has <code>evalVolumeIntegrals</code> and <code>evalBoundaryIntegrals</code> as high level functions.  There are several different ways of calculating both the volume and boundary integrals.  The options dictionary is used to decide what mid level function to call.  Each mid level function implements a different way of doing the calculation.</p>
<p>The purpose of mid level functions is to loop over the mesh and call a low level function for each node.  For example, the function <code>getEulerFlux</code> loops over the nodes of the mesh and calls a function to calculate the Euler flux at each node.  Mid level function names usually start with <code>get</code> to indicate that their purpose is to calculate some quantity but don't do the calculation themselves.</p>
<p>Low level functions calculate a quantity at a node.  For example, <code>calcEulerFlux</code> calculates the Euler flux at a single node.  Low level function names usually start with <code>calc</code> to indicate that they perform a specific calculation. Often, different discretizations use the same structure of loops, but do a slightly different calculation at each node.  Low level functions are called inside the innermost loop of the code, so it would be too expensive to have if statements to select which low level function to call, so various tricks involving Julia's multiple dispatch system are used to get the compiler to decide which low level function to call.  These will be described later in this document.</p>
<p>It is often useful to dispatch to low level functions based on <code>Tdim</code> and <code>var_type</code>.  For this reason the Euler equation implementation of <code>AbstractParamType</code> is</p>
<pre><code>type ParamType{Tdim, var_type, Tsol, Tres, Tmsh} &lt;: AbstractParamType{Tdim}
</code></pre>

<p>The other static parameters are necessary because <code>ParamType</code> has fields of those datatypes.</p>
<p><a id='AbstractSolutionData-implementation-1'></a></p>
<h2 id="abstractsolutiondata-implementation"><code>AbstractSolutionData</code> implementation</h2>
<p>Each physics module should define and export a subtype of <code>AbstractSolutionData{Tsol, Tres}</code>. The implementation of <code>AbstractSolutionData{Tsol, Tres}</code> must inherit the <code>Tsol</code> and <code>Tres</code> static parameters, and may have additional static parameters as well. It may also be helpful to define additional abstract types within the physics module to provide different levels of abstractions. For example, the Euler physics module defines:</p>
<pre><code>abstract AbstractEulerData{Tsol, Tres} &lt;: AbstractSolutionData{Tsol, Tres}
abstract EulerData {Tsol, Tdim, Tres, var_type} &lt;: AbstractEulerData{Tsol, Tres}
type EulerData_{Tsol, Tres, Tdim, Tmsh, var_type} &lt;: EulerData{Tsol, Tdim, Tres, var_type}
</code></pre>

<p>The first line is effectively just a name change and may not be necessary. The second line adds the static parameters <code>Tdim</code>, and <code>var_type</code> while inheriting the <code>Tsol</code> and <code>Tres</code> types from <code>AbstractEulerData</code>. <code>Tdim</code> is the dimensionality of the equation, <code>Tres</code> is the datatype of the residual variables, and <code>var_type</code> is a symbol indicating whether the equation is being solved with conservative or entropy variables. The third line defines a concrete type that implements all the features required of an <code>AbstractSolutionData</code>, and adds a static parameter <code>Tmsh</code>, the datatype of the mesh variables.   The additional static parameter is necessary because one field of <code>EulerData_</code> has type <code>Tmsh</code>. Note that there could be multiple implementations of <code>AbstractSolutionData</code> for the Euler equations, perhaps with different fields to store certain data or not. All these implementations will need to have the static parameters <code>Tsol</code>, <code>Tdim</code>, <code>Tres</code>, and <code>var_type</code>, so <code>EulerData</code> is defined as an abstract type,  allowing all implementations to inherit from it. All high level functions involved in evaluating the residual will take in an argument of type <code>EulerData</code>. Only when low level functions need to dispatch based on which implementation is  used would it take in an <code>EulerData_</code> or another implementation.</p>
<p><a id='Variable-Conversion-1'></a></p>
<h3 id="variable-conversion">Variable Conversion</h3>
<p>Some equations can be written in different variables, and need to convert between them.  To do this, it is <code>function convertFromNaturalToWorkingVars{Tsol}(params::ParamType{2, :var_type},                qc::AbstractArray{Tsol,1}, qe::AbstractArray{Tsol,1})</code></p>
<p>that converts from the "natural" variables in which to write an equation to some other set of variables at a node.  For the Euler equations, the "natural" variables would be the conservative variables, and one example of "other" variables would be the entropy variables.</p>
<p>It is also sometimes useful to define the opposite conversion, ie. from the working variables to the natural variables.</p>
<p><a id='Input-Options-1'></a></p>
<h2 id="input-options">Input Options</h2>
<p>Many of the components of PDESolver have different options that control how they work and what they do. In order to  provide a unified method of specifying these options, an dictionary  of type <code>Dict{ASCIIString, Any}</code> is read in from a disk file. This dictionary (called <code>opts</code> in function signatures), is passed to all high and mid level function so they can use values in the dictionary to determine their  control flow. Low level functions need to be extremely efficient, so they cannot have conditional logic, therefore they are not passed the dictionary. Note that retrieving values from a dictionary is very slow compared to accessing the fields of a type, so all values that are accessed repeatedly should be stored  as the field of a type.</p>
<p><a id='Functors-1'></a></p>
<h2 id="functors">Functors</h2>
<p>Functors are a trick used to get Julia's dispatch system to make decisions at compile time rather than runtime.  This is particularly useful for boundary conditions, where the list of mesh faces that have boundary conditions applied is determined at runtime, but having conditional statements that execute for every node on the mesh boundary would be slow.  Instead a construct is used as follows:</p>
<pre><code class="julia">type myBC &lt;: BCType  # create a singleton type
end

function call(obj::myBC, q::AbstractVector, bndryflux::AbstractVector)
  # calculate boundary flux here
end
</code></pre>

<p>This defines a datatype and adds a method to the <code>call</code> function for that type. The call function is what makes a datatype callable like a function.  This method is called as follows:</p>
<pre><code class="julia">functor = myBC()  # construct and object of type myBC
q = rand(4)
bndryflux = zeros(4)
functor(q, bndryflux)  # the Julia compiler turns this into call(functor, q, bndryflux)  
</code></pre>

<p>The way this is used for boundary conditions is through a two level construct where an outer function passes a functor to an inner function.  Julia's JIT with generate a method of the inner function that is specialized to the functor (this is why it is important that the functor is a datatype).  For example:</p>
<p>```julia function getBCFluxes(mesh, sbp, eqn, opts)</p>
<p>for i=1:mesh.numBC  # loop over different boundary conditions     functor_i = mesh.bndry_functor[i]  # get the functor for this boundary condition     start_index = mesh.bndry_offsets[i]     end_index = mesh.bndry_offsets[i+1] - 1     # get data for boundary faces start_index:end_index</p>
<pre><code>calcBoundaryFlux(functor_i, data for boundary faces start_index:end_index)
</code></pre>

<p>end end  # end function</p>
<p>function calcBoundaryFlux(functor_i::BCType, data for boundary faces start_index:end_index)     for i=1:length(start_index:end_index)       for j=1:num_nodes_on_face         # get data for this boundary face node         functor_i(data for this boundary face node)       end     end</p>
<p>end  # end function   ```</p>
<p>The benefit of this arrangement is that <code>mesh.numBC</code> different version of calcBoundaryFlux get compiled, one for each functor, and each version knows about the <code>call</code> method that was defined for the functor it is passed.  This two level scheme allows the compiler to make all the decisions about what function to call (ie. the <code>call</code> method of the functor), avoiding any conditional logic at runtime</p>
<p>This idea is also applicable to the flux functions used by DG methods.</p>
<h1 id="initialization-of-a-simulation">Initialization of a Simulation</h1>
<p>This section lists an outline of how a simulation gets launched After step 4, the procedure becomes a bit more complicated because there are optional steps. Only the required steps are listed below.</p>
<ol>
<li>
<p>The options dictionary is read in.  Default values are supplied for any key that is not specified, if a reasonable default value exists.</p>
</li>
<li>
<p>Second, the <code>sbp</code> operator is constructed.</p>
</li>
<li>
<p>The <code>mesh</code> object is constructed, using the options dictionary and the <code>sbp</code> operator.  Some of the options in the dictionary are used to determine how the mesh gets constructed.  For example, the options dictionary specifies what kind of mesh coloring to do.</p>
</li>
<li>
<p>The <code>eqn</code> object is constructed, using the <code>mesh</code>, <code>sbp</code>, and <code>opts</code> objects.</p>
</li>
<li>
<p>The physics module <code>init</code> function is called, which initializes the physics module and finishes any initialization that <code>mesh</code> and <code>eqn</code> objects require.</p>
</li>
<li>
<p>The initial condition is applied to <code>eqn.q_vec</code>.</p>
</li>
<li>
<p>A nonlinear solver is called.  Which solver is called and what parameters it uses are determined by the options dictionary.</p>
</li>
<li>
<p>Post-processing is done, if required by the options dictionary.</p>
</li>
</ol>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../advection/advection/" class="btn btn-neutral float-right" title="Introduction">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../../pdesolver_physics/" class="btn btn-neutral" title="PDESolver Physics Interface"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>
    
  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/USER_NAME/PACKAGE_NAME.jl" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../../pdesolver_physics/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../advection/advection/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="../../assets/mathjaxhelper.js"></script>

</body>
</html>
